<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CleanCoder - ê²Œì‹œê¸€ ìƒì„¸</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background-color: #f8f9fa;
            line-height: 1.6;
        }

        /* í—¤ë” ìŠ¤íƒ€ì¼ */
        .header {
            background: white;
            padding: 15px 0;
            border-bottom: 1px solid #e0e0e0;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
        }

        .logo {
            font-size: 28px;
            font-weight: bold;
            color: #9ACD32;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo::before {
            content: '</>';
            font-size: 32px;
            color: #ADFF2F;
        }

        .back-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
            padding: 10px;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .back-btn:hover {
            background: #f0f0f0;
            color: #9ACD32;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .profile-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #9ACD32, #ADFF2F);
            border: none;
            cursor: pointer;
            overflow: hidden;
            transition: transform 0.3s ease;
        }

        .profile-btn:hover {
            transform: scale(1.1);
        }

        /* ë©”ì¸ ì»¨í…Œì´ë„ˆ */
        .main-container {
            max-width: 900px;
            margin: 20px auto;
            padding: 0 20px;
        }

        /* ê²Œì‹œê¸€ ìƒì„¸ */
        .post-detail {
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
            overflow: hidden;
            margin-bottom: 30px;
        }

        /* ê²Œì‹œê¸€ í—¤ë” */
        .post-header {
            padding: 25px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .author-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #9ACD32, #ADFF2F);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 20px;
            flex-shrink: 0;
        }

        .author-info {
            flex: 1;
        }

        .author-name {
            font-weight: bold;
            color: #333;
            font-size: 18px;
        }

        .post-time {
            color: #666;
            font-size: 14px;
            margin-top: 3px;
        }

        .post-title {
            padding: 0 25px 15px 25px;
            font-size: 24px;
            font-weight: bold;
            color: #333;
            line-height: 1.4;
        }

        /* ì½”ë“œ ì„¹ì…˜ */
        .code-section {
            margin: 20px 25px;
            background: #1e1e1e;
            border-radius: 10px;
            overflow: hidden;
        }

        .code-header {
            background: #2d2d2d;
            padding: 12px 18px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid #404040;
        }

        .code-language {
            color: #9ACD32;
            font-size: 14px;
            font-weight: bold;
        }

        .code-actions {
            display: flex;
            gap: 10px;
        }

        .code-btn {
            background: none;
            border: none;
            color: #999;
            cursor: pointer;
            padding: 6px;
            border-radius: 4px;
            transition: color 0.3s ease;
            font-size: 14px;
        }

        .code-btn:hover {
            color: #9ACD32;
        }

        .code-content {
            padding: 20px;
            color: #f8f8f2;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.6;
            overflow-x: auto;
        }

        .code-line {
            display: flex;
            margin-bottom: 5px;
        }

        .line-number {
            color: #666;
            margin-right: 20px;
            user-select: none;
            min-width: 30px;
            text-align: right;
        }

        .line-code {
            flex: 1;
        }

        /* êµ¬ë¬¸ ê°•ì¡° */
        .keyword { color: #ff79c6; }
        .string { color: #f1fa8c; }
        .comment { color: #6272a4; }
        .function { color: #50fa7b; }
        .number { color: #bd93f9; }

        /* ê²Œì‹œê¸€ ì„¤ëª… */
        .post-description {
            padding: 0 25px 20px 25px;
            color: #333;
            font-size: 16px;
            line-height: 1.8;
        }

        /* ê²Œì‹œê¸€ í•˜ë‹¨ */
        .post-footer {
            padding: 20px 25px;
            border-top: 1px solid #f0f0f0;
            display: flex;
            align-items: center;
            gap: 25px;
        }

        .action-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            background: none;
            border: none;
            cursor: pointer;
            padding: 10px 15px;
            border-radius: 25px;
            transition: all 0.3s ease;
            color: #666;
            font-size: 15px;
        }

        .action-btn:hover {
            background: #f0f0f0;
        }

        .action-btn.liked {
            color: #ff4757;
        }

        .action-btn.liked:hover {
            background: rgba(255, 71, 87, 0.1);
        }

        /* ëŒ“ê¸€ ì„¹ì…˜ */
        .comments-section {
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
            overflow: hidden;
        }

        .comments-header {
            padding: 20px 25px;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .comments-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }

        .comments-count {
            color: #9ACD32;
            font-weight: bold;
        }

        /* ëŒ“ê¸€ ì‘ì„± í¼ */
        .comment-form {
            padding: 20px 25px;
            border-bottom: 1px solid #f0f0f0;
        }

        .comment-input-container {
            display: flex;
            gap: 15px;
            align-items: flex-start;
        }

        .comment-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #9ACD32, #ADFF2F);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            flex-shrink: 0;
        }

        .comment-input-wrapper {
            flex: 1;
        }

        .comment-input {
            width: 100%;
            min-height: 80px;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 14px;
            font-family: inherit;
            resize: vertical;
            outline: none;
            transition: all 0.3s ease;
        }

        .comment-input:focus {
            border-color: #9ACD32;
            box-shadow: 0 0 0 3px rgba(154, 205, 50, 0.1);
        }

        .comment-input::placeholder {
            color: #999;
        }

        .comment-form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 10px;
        }

        .comment-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .comment-btn.cancel {
            background: #f8f9fa;
            color: #666;
        }

        .comment-btn.cancel:hover {
            background: #e9ecef;
        }

        .comment-btn.submit {
            background: linear-gradient(135deg, #9ACD32, #ADFF2F);
            color: white;
        }

        .comment-btn.submit:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(154, 205, 50, 0.3);
        }

        .comment-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* ëŒ“ê¸€ ëª©ë¡ */
        .comments-list {
            padding: 0 25px 25px 25px;
        }

        .comment-item {
            padding: 20px 0;
            border-bottom: 1px solid #f5f5f5;
        }

        .comment-item:last-child {
            border-bottom: none;
        }

        .comment-content {
            display: flex;
            gap: 12px;
        }

        .comment-author-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(135deg, #9ACD32, #ADFF2F);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 14px;
            flex-shrink: 0;
        }

        .comment-body {
            flex: 1;
        }

        .comment-author {
            font-weight: bold;
            color: #333;
            font-size: 14px;
        }

        .comment-time {
            color: #999;
            font-size: 12px;
            margin-left: 8px;
        }

        .comment-text {
            margin-top: 8px;
            color: #333;
            font-size: 14px;
            line-height: 1.6;
            word-break: break-word;
        }

        .comment-actions {
            margin-top: 10px;
            display: flex;
            gap: 15px;
        }

        .comment-action-btn {
            background: none;
            border: none;
            color: #999;
            cursor: pointer;
            font-size: 12px;
            padding: 5px 0;
            transition: color 0.3s ease;
        }

        .comment-action-btn:hover {
            color: #9ACD32;
        }

        .comment-action-btn.liked {
            color: #ff4757;
        }

        /* ëŒ€ëŒ“ê¸€ */
        .reply-item {
            margin-left: 48px;
            padding: 15px 0;
            border-bottom: 1px solid #f8f9fa;
        }

        .reply-item:last-child {
            border-bottom: none;
        }

        .reply-form {
            margin-left: 48px;
            margin-top: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            display: none;
        }

        .reply-form.active {
            display: block;
        }

        .reply-input {
            width: 100%;
            min-height: 60px;
            padding: 12px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            resize: vertical;
            outline: none;
            transition: all 0.3s ease;
        }

        .reply-input:focus {
            border-color: #9ACD32;
            box-shadow: 0 0 0 2px rgba(154, 205, 50, 0.1);
        }

        .reply-form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            margin-top: 10px;
        }

        .reply-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .reply-btn.cancel {
            background: #e9ecef;
            color: #666;
        }

        .reply-btn.submit {
            background: #9ACD32;
            color: white;
        }

        /* ë¡œë”© ìŠ¤í”¼ë„ˆ */
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #9ACD32;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ë°˜ì‘í˜• ë””ìì¸ */
        @media (max-width: 768px) {
            .main-container {
                margin: 10px auto;
                padding: 0 15px;
            }
            
            .post-header,
            .post-title,
            .post-description,
            .post-footer,
            .comments-header,
            .comment-form,
            .comments-list {
                padding-left: 20px;
                padding-right: 20px;
            }
            
            .code-section {
                margin-left: 20px;
                margin-right: 20px;
            }
            
            .comment-input-container {
                gap: 10px;
            }
            
            .reply-item,
            .reply-form {
                margin-left: 30px;
            }
        }
    </style>
</head>
<body>
    <!-- í—¤ë” -->
    <header class="header">
        <div class="header-content">
            <div style="display: flex; align-items: center; gap: 15px;">
                <button class="back-btn" onclick="goBack()">â†</button>
                <a href="#" class="logo">CleanCoder</a>
            </div>
            
            <div class="header-actions">
                <button class="profile-btn" onclick="alert('í”„ë¡œí•„ ë©”ë‰´ê°€ ì—´ë¦½ë‹ˆë‹¤!')">
                    <div style="background: linear-gradient(135deg, #9ACD32, #ADFF2F); width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">ê¹€</div>
                </button>
            </div>
        </div>
    </header>

    <!-- ë©”ì¸ ì»¨í…Œì´ë„ˆ -->
    <div class="main-container">
        <!-- ê²Œì‹œê¸€ ìƒì„¸ -->
        <article class="post-detail" id="postDetail">
            <div class="loading">
                <div class="spinner"></div>
                ê²Œì‹œê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
            </div>
        </article>

        <!-- ëŒ“ê¸€ ì„¹ì…˜ -->
        <section class="comments-section">
            <div class="comments-header">
                <h3 class="comments-title">ëŒ“ê¸€</h3>
                <span class="comments-count" id="commentsCount">0ê°œ</span>
            </div>

            <!-- ëŒ“ê¸€ ì‘ì„± í¼ -->
            <div class="comment-form">
                <div class="comment-input-container">
                    <div class="comment-avatar">ê¹€</div>
                    <div class="comment-input-wrapper">
                        <textarea 
                            class="comment-input" 
                            id="commentInput"
                            placeholder="ëŒ“ê¸€ì„ ì‘ì„±í•´ì£¼ì„¸ìš”..."
                            maxlength="1000"
                        ></textarea>
                        <div class="comment-form-actions">
                            <button class="comment-btn cancel" onclick="clearCommentForm()">ì·¨ì†Œ</button>
                            <button class="comment-btn submit" id="submitCommentBtn" onclick="submitComment()">ëŒ“ê¸€ ì‘ì„±</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ëŒ“ê¸€ ëª©ë¡ -->
            <div class="comments-list" id="commentsList">
                <div class="loading">
                    <div class="spinner"></div>
                    ëŒ“ê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
                </div>
            </div>
        </section>
    </div>

    <script>
   
        // ì „ì—­ ë³€ìˆ˜
        let currentPostId = null;
        let userSession = null;
        let parseSession = null;
        let writeUserId = null;

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        window.addEventListener('load', function() {
            initializePage();
        });

        // í˜ì´ì§€ ì´ˆê¸°í™”
        function initializePage() {
        	
        	userSession = sessionStorage.getItem("userSession");                
            parseSession = JSON.parse(userSession);
            
             if (userSession == null || parseSession.accessToken == null) {
                alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                window.location.href = '/auth/login';
                return;
            }  
            
            writeUserId = parseSession.id;
             
            const urlParams = new URLSearchParams(window.location.search);
            currentPostId = urlParams.get('id'); 
            
            // ì‚¬ìš©ì ì•„ë°”íƒ€ ì—…ë°ì´íŠ¸
            updateUserAvatars();

            // ë°ì´í„° ë¡œë“œ
            loadPostDetail();
            loadComments();
        }

        // ì‚¬ìš©ì ì•„ë°”íƒ€ ì—…ë°ì´íŠ¸
        function updateUserAvatars() {
            if (userSession && userSession.name) {
                const avatars = document.querySelectorAll('.comment-avatar, .profile-btn div');
                avatars.forEach(avatar => {
                    avatar.textContent = userSession.name.charAt(0);
                });
            }
        }

        // ê²Œì‹œê¸€ ìƒì„¸ ì •ë³´ ë¡œë“œ
        async function loadPostDetail() {
            try {
                const response = await fetch(`/api/post/detail?id=${currentPostId}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${parseSession.accessToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const post = await response.json();
                    renderPostDetail(post);
                } else if (response.status === 401) {
                    alert('ë¡œê·¸ì¸ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
                    window.location.href = '/auth/login';
                } else if (response.status === 404) {
                    alert('ê²Œì‹œê¸€ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    goBack();
                } else {
                    throw new Error('ê²Œì‹œê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                console.error('ê²Œì‹œê¸€ ë¡œë“œ ì˜¤ë¥˜:', error);
                document.getElementById('postDetail').innerHTML = 
                    '<div style="text-align: center; padding: 40px; color: #ff4757;">ê²Œì‹œê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</div>';
            }
        }

        // ê²Œì‹œê¸€ ìƒì„¸ ë Œë”ë§
        function renderPostDetail(post) {
            const postDetail = document.getElementById('postDetail');
            const avatarLetter = post.writeUserName ? post.writeUserName.charAt(0) : '?';
            const timeAgo = formatTimeAgo(post.updateAt);
            const language = getLanguageFromPostType(post.language);

            postDetail.innerHTML = `
                <div class="post-header">
                    <div class="author-avatar">${avatarLetter}</div>
                    <div class="author-info">
                        <div class="author-name">${escapeHtml(post.writeUserName || 'ìµëª…')}</div>
                        <div class="post-time">${timeAgo}</div>
                    </div>
                </div>
                
                ${post.title ? `<div class="post-title">${escapeHtml(post.title)}</div>` : ''}
                
                ${post.code ? createCodeSection(post.code, language) : ''}
                
                ${post.content ? `<div class="post-description">${escapeHtml(post.content)}</div>` : ''}
                
                <div class="post-footer">
                    <button class="action-btn" onclick="togglePostLike(this)">
                        â¤ï¸ <span>${post.likeCount || 0}</span>
                    </button>
                    <button class="action-btn">
                        ğŸ’¬ <span id="postCommentCount">${post.commentCount || 0}</span>
                    </button>
                </div>
            `;
        }

        // ëŒ“ê¸€ ëª©ë¡ ë¡œë“œ
        async function loadComments() {
            try {
                const response = await fetch(`/api/post/selectComment?id=${currentPostId}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${parseSession.accessToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const comments = await response.json();
                    renderComments(comments);
                } else if (response.status === 401) {
                    alert('ë¡œê·¸ì¸ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
                    window.location.href = '/auth/login';
                } else {
                    throw new Error('ëŒ“ê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                console.error('ëŒ“ê¸€ ë¡œë“œ ì˜¤ë¥˜:', error);
                document.getElementById('commentsList').innerHTML = 
                    '<div style="text-align: center; padding: 40px; color: #ff4757;">ëŒ“ê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</div>';
            }
        }

        // ëŒ“ê¸€ ëª©ë¡ ë Œë”ë§
        function renderComments(comments) {
            const commentsList = document.getElementById('commentsList');
            const commentsCount = document.getElementById('commentsCount');
            
            if (!comments || comments.length === 0) {
                commentsList.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;">ì•„ì§ ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤. ì²« ë²ˆì§¸ ëŒ“ê¸€ì„ ì‘ì„±í•´ë³´ì„¸ìš”!</div>';
                commentsCount.textContent = '0ê°œ';
                return;
            }

            // ëŒ“ê¸€ ìˆ˜ ì—…ë°ì´íŠ¸
            const totalComments = comments.reduce((total, comment) => {
                return total + 1 + (comment.replies ? comment.replies.length : 0);
            }, 0);
            
            commentsCount.textContent = `${totalComments}ê°œ`;
            
            // ê²Œì‹œê¸€ì˜ ëŒ“ê¸€ ìˆ˜ë„ ì—…ë°ì´íŠ¸
            const postCommentCount = document.getElementById('postCommentCount');
            if (postCommentCount) {
                postCommentCount.textContent = totalComments;
            }

            // ëŒ“ê¸€ HTML ìƒì„±
            let commentsHtml = '';
            comments.forEach(comment => {
                commentsHtml += createCommentElement(comment);
                
                // ëŒ€ëŒ“ê¸€ì´ ìˆìœ¼ë©´ ì¶”ê°€
                if (comment.replies && comment.replies.length > 0) {
                    comment.replies.forEach(reply => {
                        commentsHtml += createReplyElement(reply, comment.id);
                    });
                }
                
                // ëŒ€ëŒ“ê¸€ ì‘ì„± í¼ ì¶”ê°€
                commentsHtml += createReplyForm(comment.id);
            });

            commentsList.innerHTML = commentsHtml;
        }

        // ê°œë³„ ëŒ“ê¸€ ì—˜ë¦¬ë¨¼íŠ¸ ìƒì„±
        function createCommentElement(comment) {
            const avatarLetter = comment.authorName ? comment.authorName.charAt(0) : '?';
            const timeAgo = formatTimeAgo(comment.createdAt);

            return `
                <div class="comment-item" data-comment-id="${comment.id}">
                    <div class="comment-content">
                        <div class="comment-author-avatar">${avatarLetter}</div>
                        <div class="comment-body">
                            <div>
                                <span class="comment-author">${escapeHtml(comment.authorName || 'ìµëª…')}</span>
                                <span class="comment-time">${timeAgo}</span>
                            </div>
                            <div class="comment-text">${escapeHtml(comment.content)}</div>
                            <div class="comment-actions">
                                <button class="comment-action-btn" onclick="toggleCommentLike(this, '${comment.id}')">
                                    ğŸ‘ <span>${comment.likeCount || 0}</span>
                                </button>
                                <button class="comment-action-btn" onclick="toggleReplyForm('${comment.id}')">
                                    ğŸ’¬ ë‹µê¸€
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // ëŒ€ëŒ“ê¸€ ì—˜ë¦¬ë¨¼íŠ¸ ìƒì„±
        function createReplyElement(reply, parentId) {
            const avatarLetter = reply.authorName ? reply.authorName.charAt(0) : '?';
            const timeAgo = formatTimeAgo(reply.createdAt);

            return `
                <div class="reply-item" data-reply-id="${reply.id}" data-parent-id="${parentId}">
                    <div class="comment-content">
                        <div class="comment-author-avatar">${avatarLetter}</div>
                        <div class="comment-body">
                            <div>
                                <span class="comment-author">${escapeHtml(reply.authorName || 'ìµëª…')}</span>
                                <span class="comment-time">${timeAgo}</span>
                            </div>
                            <div class="comment-text">${escapeHtml(reply.content)}</div>
                            <div class="comment-actions">
                                <button class="comment-action-btn" onclick="toggleCommentLike(this, '${reply.id}')">
                                    ğŸ‘ <span>${reply.likeCount || 0}</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // ëŒ€ëŒ“ê¸€ ì‘ì„± í¼ ìƒì„±
        function createReplyForm(parentId) {
            return `
                <div class="reply-form" id="replyForm-${parentId}">
                    <textarea 
                        class="reply-input" 
                        placeholder="ë‹µê¸€ì„ ì‘ì„±í•´ì£¼ì„¸ìš”..."
                        maxlength="500"
                    ></textarea>
                    <div class="reply-form-actions">
                        <button class="reply-btn cancel" onclick="toggleReplyForm('${parentId}')">ì·¨ì†Œ</button>
                        <button class="reply-btn submit" onclick="submitReply('${parentId}')">ë‹µê¸€ ì‘ì„±</button>
                    </div>
                </div>
            `;
        }

        // ëŒ“ê¸€ ì‘ì„±
        async function submitComment() {
            const commentInput = document.getElementById('commentInput');
            const content = commentInput.value.trim();

            if (!content) {
                alert('ëŒ“ê¸€ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                commentInput.focus();
                return;
            }

            const submitBtn = document.getElementById('submitCommentBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'ì‘ì„± ì¤‘...';

            try {
                const response = await fetch(`/api/post/writeComment`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${parseSession.accessToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                    	postId : currentPostId,
                    	writeUserId : writeUserId,
                        content: content
                    })
                });

                if (response.ok) {
                    const newComment = await response.json();
                    commentInput.value = '';
                    loadComments(); // ëŒ“ê¸€ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                    alert('ëŒ“ê¸€ì´ ì‘ì„±ë˜ì—ˆìŠµë‹ˆë‹¤.');
                } else if (response.status === 401) {
                    alert('ë¡œê·¸ì¸ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
                    window.location.href = '/auth/login';
                } else {
                    throw new Error('ëŒ“ê¸€ ì‘ì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                console.error('ëŒ“ê¸€ ì‘ì„± ì˜¤ë¥˜:', error);
                alert('ëŒ“ê¸€ ì‘ì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'ëŒ“ê¸€ ì‘ì„±';
            }
        }

        // ëŒ€ëŒ“ê¸€ ì‘ì„±
        async function submitReply(parentId) {
            const replyForm = document.getElementById(`replyForm-${parentId}`);
            const replyInput = replyForm.querySelector('.reply-input');
            const content = replyInput.value.trim();

            if (!content) {
                alert('ë‹µê¸€ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                replyInput.focus();
                return;
            }

            const submitBtn = replyForm.querySelector('.reply-btn.submit');
            submitBtn.disabled = true;
            submitBtn.textContent = 'ì‘ì„± ì¤‘...';

            try {
                const response = await fetch(`/api/post/${currentPostId}/comments/${parentId}/replies`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${parseSession.accessToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        content: content
                    })
                });

                if (response.ok) {
                    const newReply = await response.json();
                    replyInput.value = '';
                    toggleReplyForm(parentId); // í¼ ë‹«ê¸°
                    loadComments(); // ëŒ“ê¸€ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                    alert('ë‹µê¸€ì´ ì‘ì„±ë˜ì—ˆìŠµë‹ˆë‹¤.');
                } else if (response.status === 401) {
                    alert('ë¡œê·¸ì¸ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
                    window.location.href = '/auth/login';
                } else {
                    throw new Error('ë‹µê¸€ ì‘ì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                console.error('ë‹µê¸€ ì‘ì„± ì˜¤ë¥˜:', error);
                alert('ë‹µê¸€ ì‘ì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'ë‹µê¸€ ì‘ì„±';
            }
        }

        // ëŒ“ê¸€ ì¢‹ì•„ìš” í† ê¸€
        async function toggleCommentLike(button, commentId) {
            const isLiked = button.classList.contains('liked');
            const countSpan = button.querySelector('span');
            let count = parseInt(countSpan.textContent);

            try {
                const response = await fetch(`/api/comments/${commentId}/like`, {
                    method: isLiked ? 'DELETE' : 'POST',
                    headers: {
                        'Authorization': `Bearer ${parseSession.accessToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    if (isLiked) {
                        button.classList.remove('liked');
                        countSpan.textContent = Math.max(0, count - 1);
                    } else {
                        button.classList.add('liked');
                        countSpan.textContent = count + 1;
                    }
                } else if (response.status === 401) {
                    alert('ë¡œê·¸ì¸ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
                    window.location.href = '/auth/login';
                } else {
                    throw new Error('ì¢‹ì•„ìš” ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                console.error('ëŒ“ê¸€ ì¢‹ì•„ìš” ì˜¤ë¥˜:', error);
                alert('ì¢‹ì•„ìš” ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ê²Œì‹œê¸€ ì¢‹ì•„ìš” í† ê¸€
        async function togglePostLike(button) {
            const isLiked = button.classList.contains('liked');
            const countSpan = button.querySelector('span');
            let count = parseInt(countSpan.textContent);

            try {
                const response = await fetch(`/api/post/${currentPostId}/like`, {
                    method: isLiked ? 'DELETE' : 'POST',
                    headers: {
                        'Authorization': `Bearer ${parseSession.accessToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    if (isLiked) {
                        button.classList.remove('liked');
                        countSpan.textContent = Math.max(0, count - 1);
                    } else {
                        button.classList.add('liked');
                        countSpan.textContent = count + 1;
                    }
                } else if (response.status === 401) {
                    alert('ë¡œê·¸ì¸ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
                    window.location.href = '/auth/login';
                } else {
                    throw new Error('ì¢‹ì•„ìš” ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                console.error('ê²Œì‹œê¸€ ì¢‹ì•„ìš” ì˜¤ë¥˜:', error);
                alert('ì¢‹ì•„ìš” ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ëŒ€ëŒ“ê¸€ í¼ í† ê¸€
        function toggleReplyForm(parentId) {
            const replyForm = document.getElementById(`replyForm-${parentId}`);
            const isActive = replyForm.classList.contains('active');
            
            // ëª¨ë“  ëŒ€ëŒ“ê¸€ í¼ ë‹«ê¸°
            document.querySelectorAll('.reply-form').forEach(form => {
                form.classList.remove('active');
                form.querySelector('.reply-input').value = '';
            });
            
            // í˜„ì¬ í¼ë§Œ í† ê¸€
            if (!isActive) {
                replyForm.classList.add('active');
                replyForm.querySelector('.reply-input').focus();
            }
        }

        // ëŒ“ê¸€ í¼ ì´ˆê¸°í™”
        function clearCommentForm() {
            const commentInput = document.getElementById('commentInput');
            commentInput.value = '';
            commentInput.blur();
        }

        // ì½”ë“œ ì„¹ì…˜ ìƒì„± (ë©”ì¸ í˜ì´ì§€ì™€ ë™ì¼)
        function createCodeSection(code, language) {
            const lines = code.split('\n');
            const codeLines = lines.map((line, index) => {
                const highlightedLine = highlightSyntax(line, language);
                return `
                    <div class="code-line">
                        <span class="line-number">${index + 1}</span>
                        <span class="line-code">${highlightedLine}</span>
                    </div>
                `;
            }).join('');

            return `
                <div class="code-section">
                    <div class="code-header">
                        <span class="code-language">${language}</span>
                        <div class="code-actions">
                            <button class="code-btn" title="ë³µì‚¬" onclick="copyCode(this)">ğŸ“‹</button>
                            <button class="code-btn" title="ì „ì²´í™”ë©´">â›¶</button>
                        </div>
                    </div>
                    <div class="code-content">
                        ${codeLines}
                    </div>
                </div>
            `;
        }

        // ì–¸ì–´ ë§¤í•‘ í•¨ìˆ˜
        function getLanguageFromPostType(language) {
            const languageMap = {
                'JAVASCRIPT': 'JavaScript',
                'PYTHON': 'Python',
                'JAVA': 'Java',
                'CSHARP': 'C#',
                'CPP': 'C++',
                'C': 'C',
                'HTML': 'HTML',
                'CSS': 'CSS',
                'REACT': 'React',
                'VUE': 'Vue.js',
                'ANGULAR': 'Angular',
                'NODEJS': 'Node.js',
                'TYPESCRIPT': 'TypeScript',
                'GO': 'Go',
                'RUST': 'Rust',
                'PHP': 'PHP',
                'RUBY': 'Ruby',
                'SWIFT': 'Swift',
                'KOTLIN': 'Kotlin',
                'SQL': 'SQL'
            };
            
            return languageMap[language] || 'Code';
        }

        // êµ¬ë¬¸ ê°•ì¡° í•¨ìˆ˜
        function highlightSyntax(line, language) {
            let highlighted = escapeHtml(line);
            
            const keywords = ['function', 'const', 'let', 'var', 'if', 'else', 'for', 'while', 'return', 'class', 'def', 'import', 'from', 'public', 'private', 'static', 'void', 'int', 'string', 'boolean'];
            
            keywords.forEach(keyword => {
                const regex = new RegExp(`\\b${keyword}\\b`, 'g');
                highlighted = highlighted.replace(regex, `<span class="keyword">${keyword}</span>`);
            });
            
            highlighted = highlighted.replace(/(["'])((?:\\.|(?!\1)[^\\])*?)\1/g, '<span class="string">$1$2$1</span>');
            highlighted = highlighted.replace(/(\/\/.*$|#.*$)/g, '<span class="comment">$1</span>');
            highlighted = highlighted.replace(/(\/\*.*?\*\/)/g, '<span class="comment">$1</span>');
            highlighted = highlighted.replace(/\b(\d+)\b/g, '<span class="number">$1</span>');
            
            return highlighted;
        }

        // HTML ì´ìŠ¤ì¼€ì´í”„ í•¨ìˆ˜
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ì‹œê°„ í˜•ì‹ ë³€í™˜ í•¨ìˆ˜
        function formatTimeAgo(dateTime) {
            if (!dateTime) return 'ë°©ê¸ˆ ì „';
            
            const now = new Date();
            const postDate = new Date(dateTime);
            const diffMs = now - postDate;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 60) {
                return diffMins <= 1 ? 'ë°©ê¸ˆ ì „' : `${diffMins}ë¶„ ì „`;
            } else if (diffHours < 24) {
                return `${diffHours}ì‹œê°„ ì „`;
            } else if (diffDays < 7) {
                return `${diffDays}ì¼ ì „`;
            } else {
                return postDate.toLocaleDateString('ko-KR');
            }
        }

        // ì½”ë“œ ë³µì‚¬ í•¨ìˆ˜
        function copyCode(button) {
            const codeContent = button.closest('.code-section').querySelector('.code-content');
            const codeText = Array.from(codeContent.querySelectorAll('.line-code'))
                .map(line => line.textContent)
                .join('\n');
            
            navigator.clipboard.writeText(codeText).then(() => {
                const originalText = button.textContent;
                button.textContent = 'âœ…';
                setTimeout(() => {
                    button.textContent = originalText;
                }, 2000);
            }).catch(() => {
                alert('ì½”ë“œ ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            });
        }

        // ë’¤ë¡œê°€ê¸° í•¨ìˆ˜
        function goBack() {
            if (document.referrer && document.referrer.includes(window.location.hostname)) {
                window.history.back();
            } else {
                window.location.href = '/';
            }
        }

        // ì—”í„°í‚¤ë¡œ ëŒ“ê¸€ ì‘ì„± (Ctrl/Cmd + Enter)
        document.getElementById('commentInput').addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
                e.preventDefault();
                submitComment();
            }
        });

        // ëŒ“ê¸€ ì…ë ¥ ì‹œ ë²„íŠ¼ í™œì„±í™” ìƒíƒœ ë³€ê²½
        document.getElementById('commentInput').addEventListener('input', function() {
            const submitBtn = document.getElementById('submitCommentBtn');
            if (this.value.trim()) {
                submitBtn.style.opacity = '1';
            } else {
                submitBtn.style.opacity = '0.6';
            }
        });
    </script>
</body>
</html>